<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Ansible 是一个 IT 自动化工具，主要用来做自动化部署、自动化配置等。也许是因为它发展太快，官方的文档经常看得云里雾里，不易上手，本文结合博主自身的经验，介绍一些入门的概念。由于不是专业 DevOps ，水平有限，点到为止。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Ansible 入门介绍 | 三点水</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 7.1.1"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/books">Books</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-noise-link" href="/tags/Ansible/" rel="tag">Ansible</a><a class="post-tag-noise-link" href="/tags/DepOps/" rel="tag">DepOps</a></div><div class="post-time">2020-10-09</div></div></div><div class="container post-header"><h1>Ansible 入门介绍</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-ansible"><span class="toc-number">1.</span> <span class="toc-text">什么是 Ansible</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">2.</span> <span class="toc-text">Ansible 的基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nodes"><span class="toc-number">2.1.</span> <span class="toc-text">Nodes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inventory"><span class="toc-number">2.2.</span> <span class="toc-text">Inventory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#module"><span class="toc-number">2.3.</span> <span class="toc-text">Module</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#task-tag"><span class="toc-number">2.4.</span> <span class="toc-text">Task &amp; Tag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#playbook"><span class="toc-number">2.5.</span> <span class="toc-text">Playbook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#role"><span class="toc-number">2.6.</span> <span class="toc-text">Role</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E5%AE%83"><span class="toc-number">2.7.</span> <span class="toc-text">其它</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E9%83%A8%E7%BD%B2-spring-boot-%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">示例：部署 Spring Boot 服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">小结</span></a></li></ol></details></div><div class="container post-content"><p>Ansible 是一个 IT 自动化工具，主要用来做自动化部署、自动化配置等。也许是因为它发展太快，官方的文档经常看得云里雾里，不易上手，本文结合博主自身的经验，介绍一些入门的概念。由于不是专业 DevOps ，水平有限，点到为止。</p>
<h2 id="什么是-ansible"><a class="header-anchor" href="#什么是-ansible"></a>什么是 Ansible</h2>
<p>如果管理一台机器，最快的操作方式是 ssh 到这台机器上直接执行命令。</p>
<p>如果管理几台机器，笨办法是一台台操作，不过这样容易出错。命令行高手可能会用
tmux的 <code>synchronize-panes</code> 或 SecureCrt 的 “Send chat to all tabs” 等功能来多屏操作。</p>
<p>如果管理的机器有十几台或几十台，或者部署、更新操作很频繁，最好的方式就是写成脚本，这样方便重用，同时减少出错的可能性。</p>
<p>当部署的操作比较复杂时，如需要部署多个模块，每个模块的配置相互关联，部署有许多步骤时，裸写脚本会让脚本变得十分复杂。这种情形下， Ansible 提供的一些功能能方便我们管理、定制部署的内容。</p>
<h2 id="ansible-的基本概念"><a class="header-anchor" href="#ansible-的基本概念"></a>Ansible 的基本概念</h2>
<h3 id="nodes"><a class="header-anchor" href="#nodes"></a>Nodes</h3>
<p>Ansible 允许我们在一台机器上控制多台机器，如下图：</p>
<img src="/2020/Ansible-Introduction/Ansible-Nodes.svg" class="" title="Control Node and Managed Node">
<p>执行 Ansible 命令的机器称作控制节点（Control Node），这台机器上需要安装
ansible，其它机器称作受管节点（Managed Node），不需要安装 ansible。</p>
<p>Ansible 要求控制节点到受管节点之间要配置 ssh 免密登录，侧面说明 ansible 在执行时就是 ssh 到受管节点上再执行相应的命令。也因此在执行命令时需要受管节点本身安装好相应的命令（如解压 zip 包需要安装 unzip 命令）。</p>
<h3 id="inventory"><a class="header-anchor" href="#inventory"></a>Inventory</h3>
<p>Inventory 可以翻译成“清单”，Ansible 要管理许多机器，那这些机器的 IP 在哪里存储、获取呢？Ansible 定义了 <a href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#inventory-basics-formats-hosts-and-groups">inventory 格式
</a>
，我们只需要把要管理的机器按格式保存成文件即可（一般会命名为 <code>hosts</code>）。如 ini
的格式如下：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mail.example.com</span><br><span class="line"></span><br><span class="line">[webservers]</span><br><span class="line">foo.example.com</span><br><span class="line">bar.example.com</span><br><span class="line"></span><br><span class="line">[dbservers]</span><br><span class="line">one.example.com</span><br><span class="line">two.example.com</span><br><span class="line">three.example.com</span><br></pre></td></tr></table></figure></div>
<p>其中的 <code>[webservers]</code> 是“组”，之后在需要填写机器的地方写的都是“组名”（当然还有其它写法）。</p>
<p>如果你管理的机器很多，ansible 还支持这样一些语法，来代表范围（具体的格式可以查阅文档）：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">www[01:50].example.com</span><br><span class="line"></span><br><span class="line">[databases]</span><br><span class="line">db-[a:f].example.com</span><br></pre></td></tr></table></figure></div>
<h3 id="module"><a class="header-anchor" href="#module"></a>Module</h3>
<p>我们说过，ansible 的作用相当于 ssh 到目标机器上执行脚本。有些任务用脚本写起来会比较麻烦，Ansible 就把这些任务抽象成一个方便配置的模块，就是 module，它是
Ansible 执行的最小代码单元。</p>
<p>例如部署时我们常需要把安装包 scp 到目标机器，再解压。压缩格式不同还需要调用不同的解压命令，而 ansible 把这个功能抽象成 <code>unarchive</code> module，只需要简单配置就可以实现功能。例如将控制节点上的 JDK 解压到受管节点中，只需要指定路径即可：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">and</span> <span class="string">unzip</span> <span class="string">jdk</span></span><br><span class="line">  <span class="attr">unarchive:</span> <span class="string">src=&#123;&#123;jdk_local_file_path&#125;&#125;</span> <span class="string">dest=&#123;&#123;jdk_install_path&#125;&#125;</span></span><br></pre></td></tr></table></figure></div>
<h3 id="task-tag"><a class="header-anchor" href="#task-tag"></a>Task &amp; Tag</h3>
<p>Task 即任务，如果说 module 对应于脚本中的一个命令，task 就是命令加参数，用来实现一个具体的操作。</p>
<p>例如上面的解压 JDK 示例其实就是一个 task。其中的 <code>unarchive</code> 是 module，而
<code>src</code>, <code>dest</code> 是具体的参数，加上 <code>name</code> 这个额外的标记信息，整体描述了一个具体的操作。</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">and</span> <span class="string">unzip</span> <span class="string">jdk</span></span><br><span class="line">  <span class="attr">unarchive:</span> <span class="string">src=&#123;&#123;jdk_local_file_path&#125;&#125;</span> <span class="string">dest=&#123;&#123;jdk_install_path&#125;&#125;</span></span><br><span class="line">  <span class="attr">tag:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">install</span></span><br></pre></td></tr></table></figure></div>
<p>Task 描述了具体的操作，那么如何控制操作的执行时机呢？例如解压 JDK 的操作只希望在安装的时候执行，而后续更新服务时不希望执行。</p>
<p>Ansible 中提供的一种机制是 Tag（标签）。在后续执行时，可以指定一个或多个标签，只有标签匹配的任务才会被执行。这个机制使得 ansible 比自制脚本更加灵活。</p>
<h3 id="playbook"><a class="header-anchor" href="#playbook"></a>Playbook</h3>
<p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html">Playbook</a>
翻译为“剧本”，如果把 task 看作一个个动作，剧本的作用就是串联这些动作，来实现全局的目的。一个剧本可以包含多场“戏”（Play），每场戏至少需要定义两个要素：</p>
<ul>
<li>目标机器，通过 <a href="https://docs.ansible.com/ansible/latest/user_guide/intro_patterns.html#intro-patterns">pattern</a> 语法指定</li>
<li>至少一个 task</li>
</ul>
<p>下例的第一场戏中，ansible 在 webservers 上执行任务，第二场戏中在databases上执行任务：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">update</span> <span class="string">web</span> <span class="string">servers</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line">    <span class="attr">yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">/srv/httpd.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/httpd.conf</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">update</span> <span class="string">db</span> <span class="string">servers</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">databases</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">postgresql</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line">    <span class="attr">yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">that</span> <span class="string">postgresql</span> <span class="string">is</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span></span><br></pre></td></tr></table></figure></div>
<p>默认情况下，ansible 会按剧本里的任务一项项顺序执行，每项任务都会在指定的所有目标机器上执行。如果有一台机器上执行失败，则这台机器将不再参与该剧本后续任务的执行。当然，执行的策略也是可以改的，参考：
<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_strategies.html#playbooks-strategies">strategies</a>。</p>
<h3 id="role"><a class="header-anchor" href="#role"></a>Role</h3>
<p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html">Role</a>
翻译成“角色”，它是 ansible 的一个组织上的概念。有时候我们可能会有许多剧本，而不同剧本可能只是组织的顺序不同，任务本身是一样的，于是我们把它们组织成一个个“角色”，一个剧本可以直接邀请角色，一个角色可以出演多个剧本，组织更清晰，也方便复用。</p>
<p>实际上，ansible 中要完成一项任务，还会使用到许多概念，比如需要读取设置变量；定义文件模板；自定义 module 等等。于是 ansible 要求我们按指定的目录格式来组织：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># playbooks</span><br><span class="line">site.yml</span><br><span class="line">webservers.yml</span><br><span class="line">fooservers.yml</span><br><span class="line">roles/</span><br><span class="line">    common/</span><br><span class="line">        tasks/     # main.yml 执行的 task</span><br><span class="line">        handlers/  # main.yml handlers，可在本角色或角色外使用</span><br><span class="line">        library/   # my_module.yml 本角色中可使用的自定义 module</span><br><span class="line">        files/     # main.yml 部署的文件</span><br><span class="line">        templates/ # main.yml 部署的模板</span><br><span class="line">        defaults/  # main.yml 使用有默认值的变量，可以被覆盖，最低优先级</span><br><span class="line">        vars/      # main.yml 的其它变量</span><br><span class="line">        meta/      # main.yml meta 信息，如角色的依赖关系</span><br><span class="line">    webservers/</span><br><span class="line">        tasks/</span><br><span class="line">        defaults/</span><br><span class="line">        meta/</span><br></pre></td></tr></table></figure></div>
<ul>
<li>每个角色都要放在 <code>roles</code> 目录下，且单独成目录，如 <code>roles/common/</code></li>
<li>每个“功能”独自成目录（如 <code>tasks/</code>），且默认生效的配置为目录下的 <code>main.yml</code>
文件</li>
</ul>
<p>定义了 role 后就可以在 play 中使用：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">roles:</span>             <span class="comment"># 通过 roles 指定引入的角色</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">common</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">webservers</span></span><br></pre></td></tr></table></figure></div>
<p>还有复杂的用法：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">common</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">foo_app_instance</span></span><br><span class="line">      <span class="attr">vars:</span>                   <span class="comment"># 覆盖变量</span></span><br><span class="line">        <span class="attr">dir:</span> <span class="string">&#x27;/opt/a&#x27;</span></span><br><span class="line">        <span class="attr">app_port:</span> <span class="number">5000</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">typeA</span>             <span class="comment"># 给 role 里的所有 task 添加 tag</span></span><br></pre></td></tr></table></figure></div>
<h3 id="其它"><a class="header-anchor" href="#其它"></a>其它</h3>
<p>这里只介绍一些组织上的概念，在实际编写 ansible 时，还需要许多变量上的操作，如<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html">
条件判断
</a>
、<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html">循环
</a>等，以及一些<a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/">内置的
module</a>
，麻烦读者在使用时查阅相关文档。</p>
<h2 id="示例：部署-spring-boot-服务"><a class="header-anchor" href="#示例：部署-spring-boot-服务"></a>示例：部署 Spring Boot 服务</h2>
<p>下面我们写一个简单的 ansible 工程，用于安装、部署、启停 spring boot 任务。目的是对 ansible 的工程结构及脚本有大概的认识。这里会贴出所有的代码，比较长，不想了解细节可以先跳过。</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight txt"><figcaption><span>目录结构</span></figcaption><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── hosts                   # inventory</span><br><span class="line">├── roles</span><br><span class="line">│   ├── jdk</span><br><span class="line">│   │   └── tasks</span><br><span class="line">│   │       └── main.yml    # 部署步骤</span><br><span class="line">│   └── webapp</span><br><span class="line">│       ├── files</span><br><span class="line">│       │   └── webapp.jar  # 服务 jar 包</span><br><span class="line">│       ├── tasks</span><br><span class="line">│       │   └── main.yml    # 部署步骤</span><br><span class="line">│       ├── templates</span><br><span class="line">│       │   └── application.properties.j2  # spring boot 配置文件模板</span><br><span class="line">│       └── vars</span><br><span class="line">│           └── main.yml    # 部署参数</span><br><span class="line">├── vars.yml                # 全局参数</span><br><span class="line">└── webapp.yml              # playbook</span><br></pre></td></tr></table></figure></div>
<p>在编写 ansible 脚本时，通常会这么做：</p>
<ol>
<li>编写 <code>hosts</code> 和 <code>vars.yaml</code>，存储机器信息和变量信息。环境变化时，一般只修改这两个文件即可</li>
<li>将目标分解成多个角色，如例子中将 jdk 和 webapp 分开</li>
<li>为每个角色编写脚本，一般在 task 只会增加 tag 来分组，有些 task 可以共用</li>
<li>编写 playbook，包含一到多个角色，串连完成目标</li>
<li>将经常执行的命令写成脚本，这点在样例中没有体现</li>
</ol>
<p>当然 ansible 只提供机制，部署的脚本不只一种，这里描述的是博主的习惯。具体的文件内容如下：</p>
<figure class="highlight ini"><figcaption><span>hosts</span><a href="/downloads/code/ansible-playground/hosts">view raw</a></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[webservers]</span></span><br><span class="line">192.168.1.10</span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><figcaption><span>vars.yml</span><a href="/downloads/code/ansible-playground/vars.yml">view raw</a></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">webapp_port:</span> <span class="number">9191</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><figcaption><span>webapp.yml</span><a href="/downloads/code/ansible-playground/webapp.yml">view raw</a></figcaption><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">jdk</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">webapp</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">vars.yml</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><figcaption><span>roles/jdk/tasks/main.yml</span><a href="/downloads/code/ansible-playground/roles/jdk/tasks/main.yml">view raw</a></figcaption><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;Install JDK 1.8&quot;</span></span><br><span class="line">  <span class="attr">apt:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">openjdk-8-jdk</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">install</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">yes</span> <span class="comment"># apt 需要 sudo 权限</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><figcaption><span>roles/webapp/tasks/main.yml</span><a href="/downloads/code/ansible-playground/roles/webapp/tasks/main.yml">view raw</a></figcaption><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">web</span> <span class="string">app</span></span><br><span class="line">  <span class="attr">block:</span> <span class="comment"># block 可以组合多个 task</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">path</span> <span class="string">exists</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">dest={{install_path}}</span> <span class="string">mode=0755</span> <span class="string">state=directory</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">jar</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">src=webapp.jar</span> <span class="string">dest={{install_path}}</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">generate</span> <span class="string">application</span> <span class="string">properties</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=application.properties.j2</span> <span class="string">dest={{install_path}}/application.properties</span> <span class="string">force=true</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">install</span> <span class="comment"># 注意整个脚本的 task 打了几组不同的 tag 用于分组</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">if</span> <span class="string">webapp&#x27;s</span> <span class="string">port</span> <span class="string">had</span> <span class="string">already</span> <span class="string">stopped</span></span><br><span class="line">  <span class="attr">wait_for:</span> <span class="comment"># wait for 等待端口不可访问</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">&quot;<span class="template-variable">{{server_port}}</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">stopped</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">&quot;<span class="template-variable">{{check_stop_timeout | default(3)}}</span>&quot;</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;Port <span class="template-variable">{{server_port}}</span> is accessible, <span class="template-variable">{{role_name}}</span> not stopped&quot;</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">start</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">check-stop</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">webapp</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="comment"># 执行 start</span></span><br><span class="line">    <span class="attr">chdir:</span> <span class="string">&quot;<span class="template-variable">{{install_path}}</span>&quot;</span></span><br><span class="line">    <span class="attr">cmd:</span> <span class="string">&quot;nohup java -jar webapp.jar &amp;&gt; nohup.out &amp;&quot;</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">start</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">if</span> <span class="string">port</span> <span class="string">is</span> <span class="string">accessible</span></span><br><span class="line">  <span class="attr">wait_for:</span> <span class="comment"># 等待，直到端口可访问</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">&quot;<span class="template-variable">{{server_port}}</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">&quot;<span class="template-variable">{{check_start_timeout | default(10000)}}</span>&quot;</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;Port <span class="template-variable">{{server_port}}</span> is not accessible, <span class="template-variable">{{role_name}}</span> not started&quot;</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">start</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">check-start</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">if</span> <span class="string">port</span> <span class="string">is</span> <span class="string">accessible</span></span><br><span class="line">  <span class="attr">wait_for:</span> <span class="comment"># 停止前确保端口可访问</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">&quot;<span class="template-variable">{{server_port}}</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">&quot;<span class="template-variable">{{check_start_timeout | default(3)}}</span>&quot;</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;Port <span class="template-variable">{{server_port}}</span> is not accessible, <span class="template-variable">{{role_name}}</span> not started&quot;</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">stop</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">stop</span> <span class="string">webapp</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="comment"># kill 进程</span></span><br><span class="line">    <span class="attr">chdir:</span> <span class="string">&quot;<span class="template-variable">{{install_path}}</span>&quot;</span></span><br><span class="line">    <span class="attr">cmd:</span> <span class="string">&quot;ps aux|grep webapp.jar| grep -v grep| awk &#x27;{print $2}&#x27;|xargs kill&quot;</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">stop</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">if</span> <span class="string">webapp&#x27;s</span> <span class="string">port</span> <span class="string">had</span> <span class="string">already</span> <span class="string">stopped</span></span><br><span class="line">  <span class="attr">wait_for:</span> <span class="comment"># kill 后确认端口不可访问</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">&quot;<span class="template-variable">{{server_port}}</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">stopped</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">&quot;<span class="template-variable">{{check_stop_timeout | default(300)}}</span>&quot;</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;Port <span class="template-variable">{{server_port}}</span> is accessible, <span class="template-variable">{{role_name}}</span> not stopped&quot;</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">stop</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">check-stop</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>roles/webapp/templates/application.properties.j2</span><a href="/downloads/code/ansible-playground/roles/webapp/templates/application.properties.j2">view raw</a></figcaption><table><tr><td class="code"><pre><span class="line">server.port={{server_port}}</span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><figcaption><span>roles/webapp/vars/main.yml</span><a href="/downloads/code/ansible-playground/roles/webapp/vars/main.yml">view raw</a></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">server_port:</span> <span class="string">&quot;<span class="template-variable">{{webapp_port}}</span>&quot;</span></span><br><span class="line"><span class="attr">install_path:</span> <span class="string">/home/jinzhouz/tmp/ansible</span></span><br></pre></td></tr></table></figure>
<p>有了这些部署脚本后，可以通过如下命令来安装、部署：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装, -K 在执行时会提示输入 sudo 密码，安装 JDK 时使用</span></span><br><span class="line"><span class="comment"># 由于 playbook 中包含了 jdk 与 webapp，会先后执行 jdk 与 webapp 带 install tag 的任务</span></span><br><span class="line">ansible-playbook webapp.yml -i hosts --tags install -K</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动，jdk 中没有启动步骤，只会执行 webapp 中带 start tag 的任务</span></span><br><span class="line">ansible-playbook webapp.yml -i hosts --tags start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">ansible-playbook webapp.yml -i hosts --tags stop</span><br></pre></td></tr></table></figure></div>
<h2 id="小结"><a class="header-anchor" href="#小结"></a>小结</h2>
<p>当你想写脚本部署服务时，可以考虑使用 Ansible 来替代。对于初次接触的同学，需要先了解一些 ansible 的组织概念，文中介绍了主要的一些概念：</p>
<ul>
<li>Node：节点/机器，包括控制节点(Control Node)和受管节点(Managed Node)，通过
SSH 免密通信</li>
<li>Inventory：配置文件，记录节点信息</li>
<li>Module：最小的代码单元，是 ansible 对常用命令做的抽象</li>
<li>Task：单个操作，可以认为是 Module 加上具体的参数</li>
<li>Tag：对 Task 做标记/分组，在执行时可以指定一个或多个 tag</li>
<li>Playbook：剧本，顺序组织多个 task，来完成具体目标，可以包含多场“戏”</li>
<li>Role：对 Task 的结构化组织，需要遵守特定的目录结构</li>
</ul>
<p>了解这些概念后，我们就知道 Ansible 脚本“从何写起”了。最后我们给了一个具体的示例，来安装，部署一个 Spring Boot 的 Web 服务。</p>
<p>Ansible 的功能远不止这些，本文只是抛砖引玉，更多的功能可以查阅官方文档。</p>
</div></div><div class="post-main post-comment"><div id="giscus_thread"></div><script src="https://giscus.app/client.js" data-repo="lotabout/lotabout.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMDU1NTQ0Nw==" data-category="Announcements" data-category-id="DIC_kwDOATmmt84ClmcD" data-mapping="" data-strict="" data-reactions-enabled="0" data-emit-metadata="" data-input-position="" data-theme="" data-lang="zh-CN" data-loading="" crossorigin="" async>
</script></div></article><link rel="stylesheet" type="text/css" href="/css/third-party/font-awesome/4.5.0/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/lato-font/3.0.0/css/lato-font.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.css"><script src="/js/third-party/jquery/2.0.3/jquery.min.js"></script><script src="/js/third-party/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script><script async src="https://www.googletagmanager.com/gtag/js?id=#{theme.google_analytics}"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-39956831-2');</script></body></html>