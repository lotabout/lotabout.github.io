title: Raft 一致性算法
tags:
---

## 复制状态机（Replicated state machines）

复制状态机将服务器看成一个状态机，而一致性算法的目的是让多台服务器/状态机能够
计算得到相同的状态，同时，如果有部分机器宕机，集群作为一个整体依然能继续工作。
复制状态机一般通过复制日志（replicated log）来实现，如下图：

{% asset_img raft-replicated-state-machine.svg Replicated State Machine %}

服务器会将客户端发来的命令存成日志，日志是有序的。而服务器状态机执行命令的结果
是确定的，这样如果每台服务器的状态机执行的命令是相同的，状态机最终的状态也会是
相同的，输出的结果也会是相同的。而如何保证不同服务器间的日志是一样的呢？这就是
其中的“一致性模块”的工作了。

一致性模块（consensus module）在收到客户端的命令时（②），一方面要将命令添加到
自己的日志队列中，同时需要与其它服务器的一致性模块沟通，确保所有的服务器将最终
拥有相同的日志，即使有些服务器可能挂了。实践中至少需要“大多数(大于一半)”服务器
同步了命令才认为同步成功了。

## Raft 算法

接下去会从 3 个方面讲解 Raft 算法：

1. 选主（Leader Election）。Raft 在同一时刻只有一个主节点能接收写命令。
2. 日志复制（Log Replication）。Raft 如何将接收到的命令复制到其它服务器上，使
   其保持一致？
3. 安全性，为什么 Raft 在各种情况下依旧能保证各服务器的日志一致性？

### 基础概念

首先是节点的 3 种状态/角色：
- Follower/从节点不发起请求，单纯响应 Candidate 和 Leader 的请求
- Leader/主节点负责响应客户端发起的请求，如果客户端的请求发送到 Follower，
    请求会被转发到主节点
- Candidate/候选节点是一种中间状态，只在选主期间存在。

它们的转换关系如下：

{% asset_img raft-server-states.svg Server States %}

其次是任期（term）的概念。Raft 将时间切分成多个 term，每个 term 以选主开始，选
主期间各节点尝试当上主节点，选举结束后开始正常处理客户端的请求。如图：

{% asset_img raft-term-definition.svg Term Definition %}

Raft 会保证每一个 term 中至多只有一个 leader，如果选主时选票被分散导致没有节点
获得多数票（如 t3），则会开始新一轮选举。

term 就像“时间”，用来记录和比较各节点的“进度”。例如由于网络情况不佳，一个主节
点 A 与其它节点失联，其它节点选了一个新的主节点 B，当网络恢复正常时，旧主节点
A 收到主节点 B 的消息时，它会判断新主节点 B 的 term 大于自己，说明自己错过了一
些事件，因此选择放弃自己的主节点身份。

### 选主 Leader Election

### Log Replication

### 安全性

## 节点变更
