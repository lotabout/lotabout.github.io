<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>分代 G1 GC - Java G1GC 小册子</title>
        
        


        <!-- Custom HTML head -->
        


        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../css/lotabout.css">
        

        
        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');
                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }
                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">JVM G1GC 小册子</a></li><li class="chapter-item expanded affix "><li class="part-title">算法篇</li><li class="chapter-item expanded "><a href="../algo/gcs.html"><strong aria-hidden="true">1.</strong> G1 简介</a></li><li class="chapter-item expanded "><a href="../algo/concurrent-marking.html"><strong aria-hidden="true">2.</strong> 并发标记</a></li><li class="chapter-item expanded "><a href="../algo/evacuation.html"><strong aria-hidden="true">3.</strong> Evacuation</a></li><li class="chapter-item expanded "><a href="../algo/soft-real-time.html"><strong aria-hidden="true">4.</strong> 软实时性</a></li><li class="chapter-item expanded "><a href="../algo/generational.html" class="active"><strong aria-hidden="true">5.</strong> 分代 G1 GC</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <a id="home" class="icon-button" type="button" title="Go to Home" href="/">
                            <i class="fa fa-home"></i>
                        </a>

                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                    </div>

                    <h1 class="menu-title">Java G1GC 小册子</h1>

                    <div class="right-buttons">

                        
                        
                        

                    </div>
                </div>

                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#分代generational-g1-gc" id="分代generational-g1-gc">分代（Generational） G1 GC</a></h1>
<p>上面几节讨论 G1 GC 虽然偶尔提到分代，但整体还是尽量弱化了分代带来的影响。但其实 Java 中的 G1 GC，默认就是分代模式。下面介绍分代 G1 GC 带来的区别。</p>
<h2><a class="header" href="#分代基础知识" id="分代基础知识">分代基础知识</a></h2>
<p>分代 GC 基于这样的<a href="https://plumbr.io/handbook/garbage-collection-in-java#generational-hypothesis">发现/假设</a>：</p>
<ul>
<li>多数对象一般创建不久后就被废弃了/死了</li>
<li>一段时间后还在使用/活着的对象，通常还会继续存在/活（非常）长的时间</li>
</ul>
<p>从对象存活时间和对象数量的视角来看，分代假设就是这样的（<a href="https://plumbr.io/app/uploads/2015/05/object-age-based-on-GC-generation-generational-hypothesis.png">原图</a>）：</p>
<p><img src="generational/object-age-based-on-GC-generation-generational-hypothesis-20211006105013-yrmxkz4.png" alt="object-age-based-on-GC-generation-generational-hypothesis.png" /></p>
<p>当然这个假设不一定符合实际，比如 LRU 缓存，越老的对象越可能被淘汰。</p>
<h2><a class="header" href="#分代的-g1gc" id="分代的-g1gc">分代的 G1GC</a></h2>
<p>在分代 G1GC 中，区域会被分成两种，一种是年轻代区域（Young Gen），一种是老年代区域（Old Gen），分别代表分代里存活短和存活长的对象。而回收也有两种模式：完全年轻代 GC（Fully Young Collection），部分年轻代 GC（Partially Young Collection）也称为混合 GC（Mixed GC）。当然还有一种Full GC，指的是当 G1 来不及回收时，退化成的 Serial 模式。</p>
<p>为什么命名这么奇怪？叫 Mixed GC？这是因为在 G1 中，Young GC 会回收所有的 Young
Gen区域，而 Mixed GC 在回收部分 Old Gen 区域外，也会回收<strong>所有的 Young Gen 区域</strong>，由于回收混合了 Young Gen 区域和 Old Gen 的区域，所以叫混合 GC。</p>
<p>要注意不管是 Young GC 还是 Mixed GC，所有的 Young Gen 区域都会被回收。</p>
<h2><a class="header" href="#rset-忽略-young-gen" id="rset-忽略-young-gen">RSet 忽略 Young Gen</a></h2>
<p>RSet 记录了跨区域的引用，在 evacuation 阶段会被用来寻找非 CSet 的引用。既然所有 Young Gen 区域都在 CSet 中，那么 RSet 中永远都不需要包含这些区域的 Card。</p>
<p>具体操作上，在 RSet 写屏障执行时<sup class="footnote-reference"><a href="#ref-code-write-barrier-short-path">1</a></sup>，会判断如果引用方在 Young Gen 中，则跳过执行，不将对象加入 DirtyCardQueue。如下图左图，正常情况下在区域 B 的 RSet 中需要包含对象 <code>a</code> 所在的 Card，但因为 <code>a</code> 在 Young
Gen 中，因此可以不记录。但反过来，Young Gen 的区域还是需要维护 RSet，记录来自
Old Gen 的引用，如下图右图。</p>
<p><img src="generational/2023-01-jvm-g1-skip-rset-for-young.svg" alt="Skip Young Gen's ref in RSet" /></p>
<h2><a class="header" href="#动态决定年轻代区域数量" id="动态决定年轻代区域数量">动态决定年轻代区域数量</a></h2>
<p>在 G1 evacuation 中，为了保证 STW 时间在用户设定的停顿时间之内，会控制 CSet 中区域的数量。但是每次 GC 时所有的 Young Gen 区域都会被回收，就会有个问题：有可能回收这些 Young Gen 区域消耗的时间就已经超过了停顿时间，这时怎么办？</p>
<p>G1 的作法是动态设定 Young Gen 区域的数量，G1 会根据历史的一些 GC 信息来预测回收一定量的 Young 区域所需的时间，并且在设置数量时都会保证预测的回收时间不大于预期的停顿时间。不过对 Young GC 和 Mixed GC ，数量设置的策略有所不同。</p>
<p>如果下一次是 Young GC，则 G1 会设置尽可能多的 Young Gen 区域，这样能充分利用内存。如果下一次是 Mixed GC，则 G1 会设置尽可能少的 Young Gen 区域（G1 会根据如新增对象速率等信息预测一个下限），这样才能在Mixed GC 时回收更多的 Old Gen 区域。</p>
<p>另外设置 Young Gen 区域数量是在回收结束时完成的<sup class="footnote-reference"><a href="#comment-when-to-set-young-gen-size">2</a></sup>。</p>
<h2><a class="header" href="#gc-何时切换" id="gc-何时切换">GC 何时切换</a></h2>
<p>什么时候跑 Young GC，什么时候跑 Mixed GC？G1 会在 Concurrent Mark 结束，
Cleanup 的时候，利用标记时统计的区域存活计数信息，计算当前堆上的垃圾占比，如果比例大于<code>G1HeapWastePercent=5</code> 则会启动 Mixed GC<sup class="footnote-reference"><a href="#ref-code-next-mixed-gc">3</a></sup>。参数名直译是“堆浪费百分比”，类比成家里堆的垃圾超过多少就需要深度清洁了。</p>
<h2><a class="header" href="#g1-中的对象晋升" id="g1-中的对象晋升">G1 中的对象晋升</a></h2>
<p>分代假设里需要有一个概念“存活时间”，以此决定一个对象是在 Young Gen 还是在 Old
Gen，那么 JVM 里是怎么表示的？对象又是怎么在代际中流转的？</p>
<p>JVM 会在对象的 header 中用 4 bit 保存对象存活的年代数，每进行一次 GC 年代数加一，当对象存活的年代数大于等于 <code>MaxTenuringThreshold=15</code> 时会“晋升”进入 Old
Gen。在此之前都会留在 Young Gen 中。Young Gen 也分成两种区域：Eden 与
Survivor。Eden 直译是伊甸园，新增的对象都分配在 Eden 区，而每次 GC 存活但还不够资格进入Old Gen 的对象，都会被转移到 Survivor 区。逻辑流程如下图（<a href="https://plumbr.io/app/uploads/2015/05/how-java-garbage-collection-works.png">原图</a>）：</p>
<p><img src="generational/how-java-garbage-collection-works-20211006105843-u5qw3te.png" alt="how-java-garbage-collection-works.png" /></p>
<p>在 G1 中，堆是切分成区域的，区域不是连续的。从区域的视角看，Young GC 的流程如下，所有 Young Gen 且只有 Young Gen 被回收，对象根据存活时间可能被复制到新的
Survivor 区域或 Old Gen 区域：</p>
<p><img src="generational/2023-01-jvm-g1-young-gc.svg" alt="Young GC" /></p>
<p>Mixed GC 的流程跟 Young GC 差不多，只是在回收时除了 Young Gen 区域还会回收部分
Old Gen 区域：</p>
<p><img src="generational/2023-01-jvm-g1-mixed-gc.svg" alt="Young GC" /></p>
<h2><a class="header" href="#大对象区域humongous" id="大对象区域humongous">大对象区域（humongous）</a></h2>
<p>除了 Eden, Survivor, Tenured 区域外，G1 中还有一类特殊的区域：大对象区（Humongous Region）。所谓的大对象（Humongous Object）是指对象的大小大于或等于区域的 50%，通常是些数组对象，这些对象会被特殊处理<sup class="footnote-reference"><a href="#ref-humongous-object">4</a></sup>：</p>
<ul>
<li>大对象会被分配在 Old Gen 中的一个或多个连续区域且独占这些区域，区域中剩余的空间就浪费了</li>
<li>通常大对象回收只在并发标记的 Cleanup 阶段或 Full GC 时。但一些基本类型的数组（如 int 数组）则可以在任意 GC 停顿中回收</li>
<li>创建大对象可能会导致一些 GC 停顿提前开始，G1 在每次大对象创建时都会检查
IHOP<sup class="footnote-reference"><a href="#ref-ihop">5</a></sup> 阈值，阈值超了的话，可能会导致 Initial mark 提前开始</li>
<li>大对象永远不会被移动，移动大对象本身也没意义（它不需要 compact 之类的操作）。潜在地，大对象区域卡在中间，可能会造成区域空间的碎片化</li>
</ul>
<h2><a class="header" href="#小结" id="小结">小结</a></h2>
<p>分代是 GC 中的优化，分段假设在 GC 中的地位应该十分重要（没有找相关资源），JDK
后续的一些低延时算法如 Shenandoah GC、ZGC，开始的实现都不包含分代，但后续的版本都在尝试实现（如<a href="https://openjdk.org/jeps/404">JEP 404</a> 提出为 Shenandoah 加上分代，<a href="https://bugs.openjdk.org/browse/JDK-8272979">JDK-8272979</a> 在 ZGC 中实现分代）。</p>
<hr />
<div class="footnote-definition" id="ref-code-write-barrier-short-path"><sup class="footnote-definition-label">1</sup>
<p><a href="https://github.com/openjdk/jdk11u-dev/blob/master/src/hotspot/share/gc/g1/g1BarrierSet.inline.hpp#L51">G1BarrierSet::write_ref_field_post</a> 中，如果引用方在 Young Gen 中，则直接退出写屏障</p>
</div>
<div class="footnote-definition" id="comment-when-to-set-young-gen-size"><sup class="footnote-definition-label">2</sup>
<p>在《深入 Java 虚拟机》一书里说是在并发标记时结束，但看 JDK 11 的调用链的入口应该是在<a href="https://github.com/openjdk/jdk11u-dev/blob/master/src/hotspot/share/gc/g1/g1CollectedHeap.cpp#L3047">回收结束时</a></p>
</div>
<div class="footnote-definition" id="ref-code-next-mixed-gc"><sup class="footnote-definition-label">3</sup>
<p><a href="https://github.com/openjdk/jdk11u-dev/blob/master/src/hotspot/share/gc/g1/g1Policy.cpp#L1084">G1Policy::next_gc_should_be_mixed</a></p>
</div>
<div class="footnote-definition" id="ref-humongous-object"><sup class="footnote-definition-label">4</sup>
<p><a href="https://docs.oracle.com/en/java/javase/11/gctuning/garbage-first-g1-garbage-collector1.html#GUID-D74F3CC7-CC9F-45B5-B03D-510AEEAC2DAC">JDK 11 Humongous Objects</a></p>
</div>
<div class="footnote-definition" id="ref-ihop"><sup class="footnote-definition-label">5</sup>
<p>Initiating Heap Occupancy</p>
</div>
<div class="footnote-definition" id="ref-code-young-target"><sup class="footnote-definition-label">6</sup>
<p><a href="https://github.com/openjdk/jdk11u-dev/blob/master/src/hotspot/share/gc/g1/g1Policy.cpp#L213">G1Policy::young_list_target_lengths</a></p>
</div>


                        <hr />
                        <div id="disqus_thread"></div>
                        <div class="giscus"></div>
                    </main>


                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../algo/soft-real-time.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>

                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../algo/soft-real-time.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        
        <!-- Google Analytics Tag -->
        <script>
            var localAddrs = ["localhost", "127.0.0.1", ""];
            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
                ga('create', 'UA-39956831-2', 'auto');
                ga('send', 'pageview');
            }
        </script>
        

        

        
        <script>
            window.playground_copyable = true;
        </script>
        

        

        

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        

        

        <!-- giscus -->
        <script src="https://giscus.app/client.js"
                data-repo="lotabout/lotabout.github.io"
                data-repo-id="MDEwOlJlcG9zaXRvcnkyMDU1NTQ0Nw=="
                data-category="Announcements"
                data-category-id="DIC_kwDOATmmt84ClmcD"
                data-mapping="pathname"
                data-strict="0"
                data-reactions-enabled="0"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="light"
                data-lang="zh-CN"
                crossorigin="anonymous"
                async>
        </script>

    </div>
    </body>
</html>
