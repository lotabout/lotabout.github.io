<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="每篇文章有多个标签，选中多个标签，要求找出含有该标签的文章。同时如果选中标签为空，则返回所有文章。Spring Data/JPA 如何实现？"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>QQA: Spring Data 如何查询属性是否在列表中 | 三点水</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 7.1.1"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/books">Books</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-noise-link" href="/tags/JPA/" rel="tag">JPA</a><a class="post-tag-noise-link" href="/tags/QQA/" rel="tag">QQA</a><a class="post-tag-noise-link" href="/tags/Spring/" rel="tag">Spring</a></div><div class="post-time">2018-11-23</div></div></div><div class="container post-header"><h1>QQA: Spring Data 如何查询属性是否在列表中</h1></div><div class="container post-content"><p>每篇文章有多个标签，选中多个标签，要求找出含有该标签的文章。同时如果选中标签为空，则返回所有文章。Spring Data/JPA 如何实现？</p>
<p>可以使用 Spring Data Specification 动态创建查询语句，最终结果如下：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PostRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Post, Long&gt;,</span><br><span class="line">    JpaSpecificationExecutor&lt;Post&gt; &#123; <span class="comment">// ①</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> List&lt;Post&gt; <span class="title function_">query</span><span class="params">(List&lt;Tag&gt; tags)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> findAll((root, cq, cb) -&gt; &#123; <span class="comment">// ②</span></span><br><span class="line">            cq.distinct(<span class="literal">true</span>); <span class="comment">// ③</span></span><br><span class="line">            <span class="keyword">if</span> (tags == <span class="literal">null</span> || tags.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span> cb.conjunction(); <span class="comment">// ④</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> root.join(<span class="string">&quot;tags&quot;</span>).in(tags); <span class="comment">// ⑤</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>上面代码的注意点：</p>
<ol>
<li>实现 <code>JpaSpecificationExecutor</code> 来启用 Specification，Repository 中会增加
<code>findAll(Specification&lt;T&gt; spec)</code> 等使用 Specification 的查询方法。</li>
<li>这里使用 Java 8 的 Lambda 表达式。等价于实现一个 <code>Specification</code> 实例。</li>
<li>返回结果为 <code>List</code>，可能会出现重复的结果，加上 <code>distinct</code> 来去重。</li>
<li><code>cb.conjunction()</code> 等价于 <code>where 1=1</code>。</li>
<li>重要：调用 <code>join</code> 来定位多对多的（或其它的关联）属性。</li>
</ol>
<h2 id="实体类定义"><a class="header-anchor" href="#实体类定义"></a>实体类定义</h2>
<p>文章类，其中一篇文章可以有多个标签 <code>Tag</code>：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Post</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ManyToMany(cascade = &#123;CascadeType.PERSIST, CascadeType.MERGE, CascadeType.DETACH, CascadeType.REFRESH&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Tag&gt; tags = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>标签类，一个标签可以被赋给多篇文章：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tag</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String createdBy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ManyToMany(mappedBy = &quot;tags&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Post&gt; posts = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h2 id="生成的-sql"><a class="header-anchor" href="#生成的-sql"></a>生成的 SQL</h2>
<p>实际查询时生成的 SQL 如下：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">distinct</span> post0_.id <span class="keyword">as</span> id1_0_,</span><br><span class="line">    post0_.name <span class="keyword">as</span> name2_0_</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    post post0_</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span></span><br><span class="line">    post_tags tags1_</span><br><span class="line">        <span class="keyword">on</span> post0_.id<span class="operator">=</span>tags1_.posts_id</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span></span><br><span class="line">    tag tag2_</span><br><span class="line">        <span class="keyword">on</span> tags1_.tags_id<span class="operator">=</span>tag2_.id</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    tag2_.id <span class="keyword">in</span> (</span><br><span class="line">        ? , ?</span><br><span class="line">    )</span><br></pre></td></tr></table></figure></div>
<h2 id="为什么用-specification"><a class="header-anchor" href="#为什么用-specification"></a>为什么用 Specification</h2>
<p>上面介绍的 Spring Specification 看起来比较复杂，其实如果只需要查询一个属性，可以直接定义 Spring Data 的 Query Method：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PostRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Post, Long&gt; &#123;</span><br><span class="line">    List&lt;Post&gt; <span class="title function_">findDistinctByTagsIn</span><span class="params">(List&lt;Tag&gt; tags)</span>; <span class="comment">// ①</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> List&lt;Post&gt; <span class="title function_">query</span><span class="params">(List&lt;Tag&gt; tags)</span> &#123; <span class="comment">// ②</span></span><br><span class="line">        <span class="keyword">if</span> (tags == <span class="literal">null</span> || tags.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> findAll();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> findDistinctByTagsIn(tags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>当然，① 处的方法不能处理 <code>tags</code> 为空时返回所有文章的需求，所以需要 ② 处的方法进行包装。</p>
<p>那么 Specification 还有什么用呢？考虑多个查询条件的组合，例如文章有多名作者，要根据作者和标签共同查询，则需要像这样实现：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit"><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PostRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Post, Long&gt; &#123;</span><br><span class="line">    List&lt;Post&gt; <span class="title function_">findDistinctByTagsIn</span><span class="params">(List&lt;Tag&gt; tags)</span>;</span><br><span class="line">    List&lt;Post&gt; <span class="title function_">findDistinctByAuthorsIn</span><span class="params">(List&lt;Author&gt; authors)</span>;</span><br><span class="line">    List&lt;Post&gt; <span class="title function_">findDistinctByAuthorsInAndTagsIn</span><span class="params">(List&lt;Author&gt; authors, List&lt;Tag&gt; tags)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> List&lt;Post&gt; <span class="title function_">query</span><span class="params">(List&lt;Author&gt; authors, List&lt;Tag&gt; tags)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((authors == <span class="literal">null</span> || authors.isEmpty()) &amp;&amp; (tags == <span class="literal">null</span> || tags.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">return</span> findAll();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (authors == <span class="literal">null</span> || authors.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> findDistinctByTagsIn(tags);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tags == <span class="literal">null</span> || tags.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> findDistinctByAuthorsIn(authors);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> findDistinctByTagsIn(tags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>这种实现方式需要增加指数级的方法数量，因此更合适用 Specification 动态生成 Query。</p>
<h2 id="参考资料"><a class="header-anchor" href="#参考资料"></a>参考资料</h2>
<ul>
<li><a href="https://rzymek.github.io/post/jpa-empty-in/">Spring Data repository with empty IN
clause</a> 跟本文探讨的问题相同，有更细致的分析。不过它处理的属性没有关联关系。</li>
<li><a href="https://www.jianshu.com/p/659e9715d01d">https://www.jianshu.com/p/659e9715d01d</a> Spring Data Specification 的一些使用示例。</li>
<li><a href="https://docs.oracle.com/javaee/6/tutorial/doc/gjivm.html">https://docs.oracle.com/javaee/6/tutorial/doc/gjivm.html</a> Criteria API，说明挺详细，然而还是看不太懂。</li>
</ul>
</div></div><div class="post-main post-comment"><div id="giscus_thread"></div><script src="https://giscus.app/client.js" data-repo="lotabout/lotabout.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMDU1NTQ0Nw==" data-category="Announcements" data-category-id="DIC_kwDOATmmt84ClmcD" data-mapping="" data-strict="" data-reactions-enabled="0" data-emit-metadata="" data-input-position="" data-theme="" data-lang="zh-CN" data-loading="" crossorigin="" async>
</script></div></article><link rel="stylesheet" type="text/css" href="/css/third-party/font-awesome/4.5.0/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/lato-font/3.0.0/css/lato-font.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.css"><script src="/js/third-party/jquery/2.0.3/jquery.min.js"></script><script src="/js/third-party/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script><script async src="https://www.googletagmanager.com/gtag/js?id=#{theme.google_analytics}"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-39956831-2');</script></body></html>